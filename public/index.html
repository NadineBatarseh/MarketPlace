<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>Ø³ÙˆÙ‚ Ù„ÙŠÙ†Ùƒ - Ø±Ø¨Ø· Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f2f5;
        }

        .card {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        button {
            background-color: #1877f2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        button:hover {
            background-color: #166fe5;
        }
    </style>
</head>

<body>
    <div class="card">
        <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø³ÙˆÙ‚ Ù„ÙŠÙ†Ùƒ</h2>
        <p>Ø§Ø¨Ø¯Ø£ Ø¨Ø±Ø¨Ø· Ù…Ù†ØªØ¬Ø§ØªÙƒ Ù…Ù† Meta Catalog Ù„ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ÙˆØ­Ø¯</p>
        <button onclick="startAuth()">Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØªØ§Ù„ÙˆØ¬</button>
    </div>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <script>
        // ØªÙ‡ÙŠØ¦Ø© Supabase Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± (ÙŠÙ‚Ø±Ø£ Ù…Ù† .env)
        let supabaseClient;

        async function initSupabase() {
            if (typeof supabase === 'undefined') {
                console.error('Supabase library not loaded');
                return;
            }
            try {
                const res = await fetch('/api/config');
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    console.error('âŒ [BROWSER] Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase:', err.error || res.statusText);
                    return;
                }
                const { supabaseUrl, supabaseAnonKey } = await res.json();
                if (!supabaseUrl || !supabaseAnonKey) {
                    console.error('âŒ [BROWSER] SUPABASE_URL Ø£Ùˆ Ø§Ù„Ù…ÙØªØ§Ø­ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ .env');
                    return;
                }
                supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);
                console.log('âœ… [BROWSER] ØªÙ… ØªÙ‡ÙŠØ¦Ø© Supabase Ø¨Ù†Ø¬Ø§Ø­');
            } catch (e) {
                console.error('âŒ [BROWSER] Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Supabase:', e);
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        async function loginForTesting() {
            console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
            console.log("ğŸ” [BROWSER] Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...");
            console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

            if (!supabaseClient) {
                console.error("âŒ [BROWSER] Supabase client not initialized");
                return;
            }

            try {
                console.log("ğŸ“¡ [BROWSER] Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Supabase...");
                console.log("   - Email: asshabmalak@gmail.com");

                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: 'asshabmalak@gmail.com',
                    password: 'e6jM&9p5wNWVy!E',
                });

                if (error) {
                    console.error("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
                    console.error("âŒ [BROWSER] ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
                    console.error("   - Error:", error.message);
                    console.error("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
                } else {
                    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
                    console.log("âœ… [BROWSER] ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!");
                    console.log("   - User ID:", data.user.id);
                    console.log("   - Email:", data.user.email);
                    console.log("   - Access Token:", data.session.access_token ? "âœ… Ù…ÙˆØ¬ÙˆØ¯" : "âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
                    console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
                    // ÙŠÙ…ÙƒÙ†Ùƒ Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹
                    window.userToken = data.session.access_token;
                }
            } catch (err) {
                console.error("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
                console.error("âŒ [BROWSER] Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
                console.error("   - Error:", err);
                console.error("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ Meta
        function startAuth() {
            console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
            console.log("ğŸš€ [BROWSER] Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ Meta...");
            console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

            // Ø¶Ø±ÙˆØ±ÙŠ: ØªÙˆÙƒÙ† Supabase ÙŠÙØ±Ø³Ù„ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¹Ø§Ø¦Ø¯ Ù…Ù† Meta Ø¹Ø¨Ø± Ù…Ø¹Ø§Ù…Ù„ state
            const token = window.userToken;
            if (!token) {
                console.error("âŒ [BROWSER] Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙˆÙƒÙ†. Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹. Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØ¸Ù‡Ø± ÙÙŠ Console: Â«ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­Â» Ø«Ù… Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                return;
            }

            const appId = '1539852660587503';
            const redirectUri = encodeURIComponent('https://attently-hard-juanita.ngrok-free.dev/auth/callback');
            const scope = 'catalog_management';
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ state Ù„ÙŠØ¹ÙŠØ¯Ù‡ Meta Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø­ØªÙ‰ ÙŠØ³ØªØ®Ø¯Ù…Ù‡ Ø§Ù„Ø³ÙŠØ±ÙØ±
            const state = encodeURIComponent(token);

            console.log("ğŸ“‹ [BROWSER] Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©:");
            console.log("   - App ID:", appId);
            console.log("   - Redirect URI:", decodeURIComponent(redirectUri));
            console.log("   - Scope:", scope);
            console.log("   - Token (state): âœ… Ù…ÙØ¶Ø§Ù Ù„Ù„Ø·Ù„Ø¨");

            const authUrl = `https://www.facebook.com/v18.0/dialog/oauth?client_id=${appId}&redirect_uri=${redirectUri}&scope=${scope}&response_type=code&state=${state}`;

            console.log("ğŸŒ [BROWSER] Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Meta...");
            console.log("   - URL:", authUrl);
            console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

            // Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© ÙÙŠØ³Ø¨ÙˆÙƒ
            window.location.href = authUrl;
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø«Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© callback
        window.addEventListener('DOMContentLoaded', async function () {
            await initSupabase();

            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
                console.log("ğŸ”„ [BROWSER] ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Meta!");
                console.log("   - Authorization Code:", code);
                console.log("   - Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±...");
                console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
            } else {
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ code
                await loginForTesting();
            }
        });

        // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø«Ù… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.addEventListener('DOMContentLoaded', function () {
            loginForTesting();
        });
    </script>

</body>

</html>